# AuditClaw - Docker Compose configuration for internal audit workflows
# Security-hardened container with isolated volume mounts
#
# Usage:
#   docker compose -f docker-compose.auditclaw.yml build
#   docker compose -f docker-compose.auditclaw.yml up -d
#   docker compose -f docker-compose.auditclaw.yml logs -f
#
# See docs/auditclaw/container-setup.md for full documentation

services:
  auditclaw:
    build:
      context: .
      dockerfile: Dockerfile.auditclaw
    image: auditclaw:local
    container_name: auditclaw

    # Security hardening
    security_opt:
      - no-new-privileges:true # Prevent privilege escalation
    cap_drop:
      - ALL # Drop all Linux capabilities
    read_only: true # Read-only root filesystem
    user: "1000:1000" # Run as non-root user

    # Network: localhost only for security
    # Gateway is only accessible from the host machine
    ports:
      - "127.0.0.1:18789:18789"

    # Isolated network with internet access
    networks:
      - auditclaw-net

    # Volume mounts with principle of least privilege
    volumes:
      # Config: AuditClaw configuration (disables device auth for containerized use)
      # Note: Create config/auditclaw.json or mount will fail
      # - ./config/auditclaw.json:/home/auditclaw/.auditclaw/openclaw.json:ro

      # Input: Documents to analyze (read-only)
      - ${AUDIT_INPUT:-~/audit-input}:/workspace/input:ro

      # Output: Generated reports and findings (read-write)
      - ${AUDIT_OUTPUT:-~/audit-output}:/workspace/output:rw

      # Skills: Community skills directory (read-only)
      - ${SKILLS_DIR:-~/auditclaw-skills}:/workspace/skills:ro

      # Config data: Persistent state like sessions, paired devices (named volume)
      - auditclaw-data:/home/auditclaw/.auditclaw/data:rw

      # Cron: Required for cron scheduler (named volume, read-write)
      - auditclaw-cron:/home/auditclaw/.auditclaw/cron:rw

      # Devices: Device pairing info (named volume, read-write)
      - auditclaw-devices:/home/auditclaw/.auditclaw/devices:rw

      # Agents: Agent state (named volume, read-write)
      - auditclaw-agents:/home/auditclaw/.auditclaw/agents:rw

      # Sessions: Session state (named volume, read-write)
      - auditclaw-sessions:/home/auditclaw/.auditclaw/sessions:rw

      # OpenClaw state: Canvas/A2UI needs this (named volume, read-write)
      - auditclaw-openclaw:/home/auditclaw/.openclaw:rw

      # Temp: Required for read_only mode (named volume, read-write)
      - auditclaw-tmp:/tmp:rw

    # Environment variables
    environment:
      # AI provider API keys (at least one required)
      # OpenRouter recommended for testing - provides many models at good prices
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - GEMINI_API_KEY=${GEMINI_API_KEY:-}
      - GROQ_API_KEY=${GROQ_API_KEY:-}

      # Gateway authentication token (required by OpenClaw gateway)
      # Default 'local' is fine since container only binds to 127.0.0.1
      # Override with OPENCLAW_GATEWAY_TOKEN in .env for LAN access
      - OPENCLAW_GATEWAY_TOKEN=${OPENCLAW_GATEWAY_TOKEN:-local}

      # Standard environment
      - HOME=/home/auditclaw
      - TERM=xterm-256color
      - NODE_ENV=production
      - OPENCLAW_STATE_DIR=/home/auditclaw/.auditclaw

    # Process management
    init: true # Use tini for proper signal handling
    restart: unless-stopped # Auto-restart on failure

    # Health check - verify gateway process is running and port 18789 (0x4965) is listening
    # Note: OpenClaw gateway uses WebSocket, HTTP check may not work
    healthcheck:
      test:
        ["CMD-SHELL", "pgrep -f 'node dist/index.js' > /dev/null && grep -q ':4965 ' /proc/net/tcp"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3

# Named volumes for persistent data
volumes:
  auditclaw-data:
    name: auditclaw-data
  auditclaw-cron:
    name: auditclaw-cron
  auditclaw-devices:
    name: auditclaw-devices
  auditclaw-agents:
    name: auditclaw-agents
  auditclaw-sessions:
    name: auditclaw-sessions
  auditclaw-openclaw:
    name: auditclaw-openclaw
  auditclaw-tmp:
    name: auditclaw-tmp

# Isolated network
# Note: This provides network namespace isolation but does NOT block
# outbound connections to local network by default. For production use
# with sensitive environments, consider adding host firewall rules to
# restrict container egress to internet-only.
networks:
  auditclaw-net:
    name: auditclaw-net
    driver: bridge
